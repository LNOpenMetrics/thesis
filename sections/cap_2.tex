\setcounter{page}{1}
\chapter{Bitcoin}

\section{Introduction}

Bitcoin is a digital currency that uses \emph{blockchain} technology to track
and verify transactions. It was created in 2009 by an unknown individual or
group using the pseudonym \emph{Satoshi Nakamoto}.
Bitcoin is decentralized, meaning that it is not controlled by any government
or institution. Instead, it relies on a network of computers around the world
to process and verify transactions.
The technology used is known with the name blockchain, and it is a transparent
and secure record of all transactions that have
ever occurred on the network.

\section{Bitcoin Basics}
\label{sec:basics}

One of the key features of Bitcoin is its limited supply. There will only ever
be 21 million bitcoins in existence, and the rate at which new bitcoins are
created is gradually decreasing. This built-in scarcity is one of the factors
that makes Bitcoin valuable.
However, the innovative idea proposed by Bitcoin was not a virtual currency that can be
exchange on internet, but Bitcoin solves the problem of authority inside this kind
of system through a proof of work protocol that was first proposed in a paper
by Adam Back in 1997 called \quotes{Hashcash - A Denial of Service Counter-Measure}.

In the context of Bitcoin, proof of work is a system that is used to secure the
blockchain and prevent fraud. It is a mathematical algorithm that requires computers
to perform a certain amount of computational work in order to create a new
block of transactions on the blockchain.
For this reason, the core ideas that make Bitcoin a solid and sicure cryptocurrency 
is also limiting the protocol in different way, and one of these limitation is the number of
transactions that the network can process for second.

The current upper limit is around 7 transactions per second, 
which is relatively low compared to other payment systems, and 
this limtiation (that it is considered a feature) can led to congestion
on the network. 
In the April of 2022 there is the first real example of congestion 
related to the limit of transactions when the usage of bitcoin
grown disproportionately as the Figure \ref{fig:fee_x_block} shows, and this
cause an increate of the transactions fee untill the point to make 
the Bitcoin unusable for small amount.

\begin{figure}
    \begin{center}
      \includegraphics[scale=0.3]{imgs/feerate_blocks.png}
    \end{center}
    \caption{Fee per block in 2021.}
    \label{fig:fee_x_block}
\end{figure}


Overall, the limited number of transactions and the scalability issues on the Bitcoin network
are significant challenges that need to be addressed in order for the network to continue
to grow and evolve. There are various proposals such as \emph{Side Chain} and \emph{Lightning Network}, 
where the Lightning Network is deep discussed inside the Section \ref{sec:lightning_network}.


\section{Bitcoin Transaction}

Transactions are a fundamental part of Bitcoin. In fact, the entire system is designed to ensure
the creation, propagation, and publication of transactions on the blockchain, but these
transactions are conceptually different from the transactions we are used to.
For example, a transaction in a relational database represents an event that triggers a
change in state within the database, where in case of malfunctions, the database returns
to the previous condition before the event was triggered.
The transactions of Bitcoin are conceptually different.

In fact, the transactions are generated by a wallet, and propagated to the network
where there are special node called \emph{mainers} that collect the transactions
validate them, and build a new block that will be proposed to be stored inside 
the blockchain. During this process the miners perform the proof of work as 
describec in \cite{Palazzo_Estrazione_di_Informazioni_2021}.
Another interesting aspect of the transactions is the concept of 
Unspend Transactions Output (UTXOs), as described in \cite{Palazzo_Estrazione_di_Informazioni_2021} 
and the meccanism to spend a transaction.
A transaction is a datastucture (as the Table \ref{tab:rawtxbitcoinc} shows) that contains the core information
of Bitcoin transaction: 

\begin{table}[H]
    \centering\small
       \begin{tabular}{|c|c|}
        \hline
        \multicolumn{2}{|c|}{\textbf{RawTransaction}} \\
        \hline
        \multicolumn{1}{|c|}{Type} & \multicolumn{1}{c|}{Name} \\       
        \hline \hline
        $int32\_t$ & version   \\
        \hline
        $uint8\_t$ & marker \\
        \hline
        $uint8\_t$ & flag \\
        \hline
        CompactSize & numberTxIn \\
        \hline
        vector<TransactionInput> & transactionsInput \\
        \hline
        CompactSize & numberTxOut \\
        \hline
        vector<TransactionOutput> & transactionsOutput \\
        \hline
        vector<TransactionWitness> & transactionsWitness \\
        \hline
    \end{tabular}   
    \caption{Transaction struct\cite{Palazzo_Estrazione_di_Informazioni_2021}.\label{tab:rawtxbitcoinc}}
\end{table}

\begin{itemize}
    \item {\bf Raw Transaction}: Main transaction concept that contains the information
        regarding the transactions input and the transactions output;
    \item {\bf transactionsInput}: A transaction spend a previous transaction contained
        inside UTXOs set, and this kind of transaction are included inside
        the transaction input array;
    \item {\bf transactionsOutput}: A wallet while creating a transaction, will spend some previous
        transaction (input transaction) and generate a new transaction called \emph{output transaction}.
\end{itemize}


\begin{example}
    \label{ex:how_spend_bitcoin}
    For example, Alice want to pay Bob with bitcoin, so in order to do that Alice
    use the own UTXO to pay Bob. The wallet of Alice in this case creates a new transaction
    capable of \emph{unlock} the Alice UTXO, and at the same time the wallet create 
    a new transaction that Bob owns (that only Bob can unlock) by including this new transaction inside the transactions output array. 

    In this way now Alice consumed the UTXO that means spend bitcoins and Bob receive bitcoin by collecting UTXO that he owns. 
    If Bob want to pay Sara, he should repete the privious step and create a transaction output that Sara can own,
    and the Figure \ref{fig:lockunlockexample} shows the example just described.

    {\centering
     \vspace{5pt}
      \includegraphics[scale=0.3]{imgs/DiagramUnlocLockUTXO.png}
      \captionof{figure}{UTXO usage as described inside the example.\cite{Palazzo_Estrazione_di_Informazioni_2021}\label{fig:lockunlockexample}}
      \vspace{10pt}
     \par}
\end{example}

In this section there is only a generic discussion about the transactions, and it is not take into count
what happens it the UTXO is not consumed in total! In the paper \cite{Palazzo_Estrazione_di_Informazioni_2021}
there is a deep discussion on how the Bitcoin Transactions works.

\section{Bitcoin Script}

At the core of Bitcoin Protocol there is a concept of transaction, and it is used to transfer value
between users on the network, where in this kind of system a user is identified by a private and public key.
In the Example \ref{ex:how_spend_bitcoin}, is described that Alice in order to pay Bob need to 
own a transaction, and in other to spend this transaction that Alice owns, the wallet should
create a new transaction capable of unlock the previous one. 

In this section we define what \emph{owns} a transactions means, and how it is possible
unlock the this type of transaction with a new one. 

\subsection{Bitcoin Script Basics}

The input and output transaction described inside the Table \ref{tab:rawtxbitcoinc} are 
implemented with a different struct as descrived inside the Table \ref{tab:tx_in_and_out}.

\begin{table}[ht]
    \centering
    \begin{tabular}{p{5cm}p{5cm}}
        \begin{tabular}{|c|c|}
            \hline
            \multicolumn{2}{|c|}{\textbf{TransactionInput}} \\
            \hline \hline
            \multicolumn{1}{|c|}{Type} & \multicolumn{1}{c|}{Name} \\
            \hline
            Outpoint & outpoint   \\
            \hline
            CScript & scriptSig \\
            \hline
            $uint32\_t$ & nSequence \\
            \hline
        \end{tabular}
         &
         \begin{tabular}{|c|c|}
             \hline
             \multicolumn{2}{|c|}{\textbf{TransactionOutput}} \\
             \hline \hline
             \multicolumn{1}{|c|}{Type} & \multicolumn{1}{c|}{Name} \\
             \hline
             $int64\_t$ & nValue   \\
             \hline
             CScript & scriptPubKey \\
             \hline
         \end{tabular}
    \end{tabular}
    \caption{Input and output transaction struct of Bitcoin Code.\cite{Palazzo_Estrazione_di_Informazioni_2021}}
    \label{tab:tx_in_and_out}
\end{table} 

The more important type for this section, is the \emph{CScript} type that store the information
the transaction owners. In particular, inside the input transaction the 
input contains a condition that is able to unlock (verify) a previous 
ouput transaction (UTXO) created, and the CScript inside the output
transaction contains the condition that need to be verified in order unlock
the transaction. The last case is also known as \emph{lock condition}.


The condition are specified with a Stack Base language called \emph{Bitcoin Script},
it is a stack base language and the particularities of this language are the
limitation of it. 
In fact, the language is not \emph{Turing Complete} and this mean that it is 
not possible express complext operation or execute statefull programs as described 
in \cite{Palazzo_Estrazione_di_Informazioni_2021}.

The execution of the transaction has two possibile result, that are: 

\begin{itemize}
    \item {\bf True}: The unlock script has succeeded in fulfilling the 
        conditions imposed by the lock script, 
        and therefore the input is a valid authorization to spend UTXO;
    \item {\bf False}: If some of the script condition are not verified.
\end{itemize}

The Bitcoin implementation (Bitcoin Core) implement different kind of scripts
that are considered standart as discussed in \cite{Palazzo_Estrazione_di_Informazioni_2021},
but the implementation also allow to run any kind of script, but in this case
the transaction in not considered a standard one\footnote{Through not standard transaction are 
implemented kind of program that are considered smart contract, such as Hash Time Lock contract, 
used in the Lightning Network.}.

\begin{example}
    An example of standard transaction that use a particular script called \emph{pay-to-multisignature} (P2MS)
    that define an M:N (many-to-many) condition where M is the minimum number of signatures required 
    to verify the lock script and N is the total number of public keys. 

    The maximum number of combinations allowed for a P2MS script is 15:15, but only 
    combinations within the range of 3:3 are considered standard, instead all other combinations 
    will be considered non-standard. The code \ref{code:p2ms} show a unlock condition:

    \begin{lstlisting}[language=bitcoinscript, caption={Full example of pay-to-multisignature script.}, label={code:p2ms}]
    OP_0 <A Signature> <B Signature>
    OP_2 <Public key A> <Public key B> <Public key C> OP_3 OP_CHECKMULTISIG
    \end{lstlisting}

    OP\_0 acts as a placeholder for a bug in the implementation of OP\_CHECKMULTISIG, 
    whose sole purpose is to work around a bug that has accidentally become a consensus rule. The stack 
    will initially be populated with the values from the unlock script.
    In this case the presence of the OP\_0 operator implies that the stack is empty when encountered, and 
    an the stack state is shows in Figure \ref{fig:stackmultsing01}.

    {\centering
    \vspace{15pt}
    \includegraphics[scale=0.35]{imgs/script/multisig/1.png}
    \captionof{figure}{Stack state after the execution of the lock script (scriptSig) in thestack.\label{fig:stackmultsing01}}
    \vspace{10pt}
    \par}

    The OP\_2 operator checks that there are 2 elements in the stack, then the three 
    public keys are pushed onto the stack, resulting in a state as shown in Figure \ref{fig:stackmultsing02}

    {\centering
    \vspace{15pt}
    \includegraphics[scale=0.35]{imgs/script/multisig/2.png}
    \captionof{figure}{Stack state after the the check with the OP\_2 operator.\label{fig:stackmultsing02}}
    \vspace{10pt}
    \par}
   
    Finally, the signatures are verified against the public keys using the 
    OP\_CHECKMULTISIG operator iteratively, meaning the first signature is compared to 
    all the public keys and this action is repeated for all signatures pushed onto the stack, 
    as shown in Figure \ref{fig:stackmultsing03}.
 
    {\centering
    \vspace{15pt}
    \includegraphics[scale=0.35]{imgs/script/multisig/3.png}
    \captionof{figure}{Esecuzione dellâ€™operatore OP\_CHECKMULTISIG per la verifica delle chiavi \cite{learnmeabitcoin:p2ms}.\label{fig:stackmultsing03}}
    \vspace{10pt}
    \par}

\end{example}

- Introduce the Bitcoin no standard
- Make a small zoom of what happens with the Bitcoin Script inside the example
